name: CD

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
        
jobs:
  linux:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        runner: [ubuntu-22.04, ubuntu-24.04-arm]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y qt6-base-dev qt6-tools-dev libglu1-mesa-dev cmake ninja-build

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja
          cmake --build build

      - name: Compress binaries
        run: |
          tar -czf qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz -C build QHugoResourceViewer

      - name: Create release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz

      - name: Upload release asset
        uses: actions/upload-artifact@v4
        with:
          name: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}
          path: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz

  macOS:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        runner: [macos-latest]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install qt cmake ninja

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja
          cmake --build build

      - name: Compress binaries
        run: |
          tar -czf qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz -C build QHugoResourceViewer.app

      - name: Create release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz

      - name: Upload release asset
        uses: actions/upload-artifact@v4
        with:
          name: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}
          path: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.tar.gz

  # windows:
  #   runs-on: ${{ matrix.runner }}
  #   strategy:
  #     matrix:
  #       runner: [windows-latest]

  #   steps:
  #     - name: Check out code
  #       uses: actions/checkout@v4

  #     - name: Install Free Pascal
  #       run: |
  #         choco install -y qt6-default cmake ninja

  #     - name: Build
  #       run: |
  #         cmake -B build -DCMAKE_BUILD_TYPE=Release -G Ninja
  #         cmake --build build

  #     - name: Compress binaries (ZIP)
  #       run: |
  #         cd build
  #         7z a ..\qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.zip *.exe

  #     - name: Create release
  #       if: success()
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.zip

  #     - name: Upload release asset
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}
  #         path: qhugo-resource-viewer-${{ runner.os }}-${{ runner.arch }}.zip
